<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<title>Hello – LinkUp Handshake Demo v7</title>
<style>
:root{--bg1:#0d0a1a;--bg2:#19122e;--card:rgba(19,16,34,.72);--card2:rgba(22,18,38,.85);--stroke:rgba(139,92,246,.28);
--text:#eaeaf6;--muted:#a5a3bb;--accent:#8b5cf6;--accent2:#a78bfa;--danger:#ff5d6c;--warn:#ffbf47;--shadow:0 8px 30px rgba(0,0,0,.35),inset 0 0 0 1px var(--stroke);--radius:18px;--radiusL:22px;--blur:saturate(120%) blur(12px)}
*{box-sizing:border-box}
body{margin:0;color:var(--text);background:radial-gradient(1200px 800px at 10% -10%,#2e1f54 0,transparent 60%),radial-gradient(1000px 600px at 110% 10%,#1e1340 0,transparent 60%),linear-gradient(180deg,var(--bg1),var(--bg2));font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100vh}
.container{max-width:1100px;margin:0 auto;padding:24px}
.appbar{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 18px;margin:16px;border-radius:var(--radiusL);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));box-shadow:var(--shadow);backdrop-filter:var(--blur)}
.brand{display:flex;align-items:center;gap:10px}.hello{font-weight:900;letter-spacing:.5px;font-size:22px;color:#b9a5ff;text-shadow:0 2px 20px rgba(167,139,250,.45)}.subtle{color:var(--muted);font-size:13px}
.role{display:flex;align-items:center;gap:8px;margin-left:8px}.chip{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);color:var(--muted);background:rgba(255,255,255,.03);font-size:12px;cursor:pointer}
.chip.active{color:#1a102f;background:var(--accent2);border-color:transparent}
.select{appearance:none;height:36px;border-radius:10px;padding:0 34px 0 12px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text)}
.small{font-size:12px;color:var(--muted)}
.identity{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:18px 0 18px}
.pair{display:flex;align-items:center;gap:16px}
.cardlet{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;background:var(--card);box-shadow:var(--shadow);backdrop-filter:var(--blur);border:1px solid var(--stroke);position:relative}
.avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;background:#261f3f}.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.name{font-weight:600}.roleTxt{font-size:12px;color:var(--muted);margin-top:2px}.between{color:var(--muted);font-size:13px}
.badgeAway{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,93,108,.45);background:rgba(255,93,108,.12);color:#ff9aa3;font-size:11px;position:absolute;top:-8px;right:-8px}
.grid{display:grid;grid-template-columns:1.2fr .85fr;gap:18px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
.panel{background:var(--card2);border-radius:var(--radiusL);border:1px solid var(--stroke);box-shadow:var(--shadow);backdrop-filter:var(--blur);padding:18px}
.summaryHead{display:flex;align-items:center;justify-content:space-between}.title{font-weight:700;letter-spacing:.3px}
.intentWrap{margin-bottom:12px}
.intentHdr{font-size:12px;color:var(--muted);margin-bottom:6px;letter-spacing:.2px}
.intent{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:12px;background:rgba(255,255,255,.04);border:1px dashed rgba(167,139,250,.35)}
.intent .pill{padding:2px 8px;border-radius:999px;background:rgba(167,139,250,.18);border:1px solid rgba(167,139,250,.4);font-size:12px;margin-right:6px}
.pintent{font-size:13px;color:#ddd}
.meter{height:10px;width:100%;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}.bar{height:100%;width:0;background:linear-gradient(90deg,#ff6580,#ffbf47,#00e0b8)}
.bullets{margin:14px 0 4px;padding-left:16px}.bullets li{margin:8px 0;color:#e7e3ff}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);cursor:pointer;transition:.15s}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}.btn:disabled{opacity:.55;cursor:not-allowed}.primary{background:linear-gradient(180deg,var(--accent2),var(--accent));border-color:transparent;color:#170e2f;font-weight:700}
.actions{display:grid;gap:10px}.note{font-size:13px;color:var(--muted)}
.confirmBox{margin-top:10px;padding:12px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(167,139,250,.35)}
.confirmTitle{font-weight:700;margin-bottom:6px}.confirmHelp{font-size:13px;color:var(--muted);margin-bottom:10px}
.confirmRow{display:flex;gap:10px;flex-wrap:wrap}
.inline{display:grid;gap:10px;margin-top:10px}.field{display:grid;gap:6px}.label{font-size:12px;color:var(--muted)}
.input, .textarea{width:100%;border-radius:10px;padding:10px 12px;color:var(--text);background:rgba(255,255,255,.04);border:1px solid var(--stroke);outline:none}
.input{height:40px}.textarea{min-height:80px;resize:vertical}
/* === Phase section (aligned) === */
.phaseWrap{margin-top:4px}
.phaseGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:0 2px}
.phase{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%;background:#5c4a93;border:1px solid var(--stroke)}
.dot.active{background:var(--accent2);border-color:var(--accent2);box-shadow:0 0 10px var(--accent2)}
.tlabel{font-size:12px;color:var(--muted)}
.progressWrap{margin-top:8px;padding:0 2px}
.progress{height:8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);overflow:hidden}
.pbar{height:100%;width:0;background:linear-gradient(90deg,#7c4dff,#a78bfa);transition:width .25s ease}
.expiry{margin-top:8px;font-size:12px;color:var(--muted);padding:0 2px}
/* Away control */
#awayCtl{display:none;align-items:center;gap:8px}
#awayCtl input{height:32px;border-radius:8px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);padding:0 8px}
.preset{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);font-size:12px;cursor:pointer}
.preset:hover{background:rgba(255,255,255,.06)}
.footer{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-top:16px}.aLite{color:#c9c2ff;text-decoration:none;border-bottom:1px dotted rgba(201,194,255,.45)}
</style>
</head>
<body>
<header class='appbar'>
  <div class='brand'><div class='hello'>Hello!</div><div class='subtle'>LinkUp · Handshake Demo v7</div></div>
  <div style='display:flex;align-items:center;gap:12px;flex-wrap:wrap'>
    <div style='display:flex;align-items:center;gap:8px'>
      <label class='subtle'>Scenario:</label><select id='scenarioSel' class='select'></select>
      <span id='scenarioAvail' class='subtle'>· —</span>
    </div>
    <div class='role'><span class='subtle'>View as:</span><button class='chip' id='asViewer'>Viewer</button><button class='chip active' id='asOwner'>Owner</button></div>
    <div class='role'><span class='subtle'>Owner availability:</span><button class='chip active' id='availOn'>Available</button><button class='chip' id='availOff'>Away</button></div>
    <div id='awayCtl' class='small'>
      <span>Away until:</span>
      <input type='datetime-local' id='awayUntil'>
      <span class='preset' data-days='1'>+1d</span>
      <span class='preset' data-days='3'>+3d</span>
      <span class='preset' data-days='7'>+7d</span>
    </div>
  </div>
</header>

<main class='container' id='app'>
  <section class='identity'>
    <div class='pair'>
      <div class='cardlet' id='ownerCard'>
        <div class='avatar'><img id='ownerAvatar' alt='owner'/></div>
        <div><div class='name' id='ownerName'>—</div><div class='roleTxt'>Signature Owner</div></div>
        <span class='badgeAway' id='awayBadge' style='display:none'>Away</span>
      </div>
      <div class='between'>↔</div>
      <div class='cardlet'><div class='avatar'><img id='viewerAvatar' alt='viewer'/></div><div><div class='name' id='viewerName'>—</div><div class='roleTxt'>Signature Viewer</div></div></div>
    </div>
  </section>

  <section class='grid'>
    <article class='panel'>
      <div class='intentWrap'>
        <div class='intentHdr'>Viewer Request</div>
        <div class='intent'><span class='pill' id='intentPill'>—</span><div><div class='pintent' id='intentText'>Viewer’s request / reason</div></div></div>
      </div>

      <div class='summaryHead'>
        <div><div class='title'>Compatibility</div><div class='subtle' id='confidenceLine'>Confidence —</div></div>
        <div style='min-width:180px;text-align:right' id='scoreBox'><div class='subtle' style='margin-bottom:6px'>Score</div><div class='meter'><div class='bar' id='scoreBar'></div></div><div style='margin-top:6px;font-weight:800;color:#d7ccff' id='scoreText'>—/100</div></div>
      </div>
      <ul class='bullets' id='bullets'><li>Loading…</li></ul>
    </article>

    <aside class='panel'>
      <div class='title' style='margin-bottom:10px'>Next step</div>
      <div class='actions' id='actions'></div>

      <div class='confirmBox' id='confirmBox' style='display:none'>
        <div class='confirmTitle' id='confirmTitle'>Confirm action</div>
        <div class='confirmHelp' id='confirmHelp'>—</div>

        <div id='declineEdit' style='display:none'>
          <div class='field'><label class='label'>Message to Viewer</label>
            <textarea id='declineMsg' class='textarea' placeholder='Thanks for reaching out. This isn’t a fit right now.'></textarea>
          </div>
          <div class='label' style='margin-top:8px'>Preview (exactly what the viewer will see):</div>
          <div class='confirmBox' style='margin-top:6px'><em id='declinePreview'>“Thanks for reaching out. This isn’t a fit right now.”</em></div>
        </div>

        <div class='confirmRow'><button class='btn' id='btnBack'>Back</button><button class='btn primary' id='btnConfirm'>Confirm</button></div>
      </div>

      <div class='inline' id='needsForm' style='display:none'>
        <div class='field'><label class='label' for='linkedin'>LinkedIn URL</label><input class='input' id='linkedin' placeholder='https://linkedin.com/in/you'></div>
        <div class='field'><label class='label' for='zip'>Zip</label><input class='input' id='zip' placeholder='11238'></div>
        <div class='confirmRow'><button class='btn' id='btnBackForm'>Back</button><button class='btn primary' id='submitNeeds'>Submit details</button></div>
      </div>

      <div class='note' style='margin-top:10px' id='actionNote'>—</div>
    </aside>
  </section>

  <section class='panel phaseWrap' style='margin-top:14px'>
    <div class='phaseGrid'>
      <div class='phase'><div class='dot' id='tlSubmitted'></div><div class='tlabel'>Submitted</div></div>
      <div class='phase'><div class='dot' id='tlViewed'></div><div class='tlabel'>Owner viewed</div></div>
      <div class='phase'><div class='dot' id='tlActed'></div><div class='tlabel'>Owner acted</div></div>
      <div class='phase'><div class='dot' id='tlScheduled'></div><div class='tlabel'>Scheduled/Closed</div></div>
    </div>
    <div class='progressWrap'><div class='progress'><div class='pbar' id='pbar'></div></div></div>
    <div class='expiry' id='expiryText'>Expires in —</div>
  </section>

  <section class='footer'>
    <button class='btn' id='btnVCard'>Download vCard</button>
    <button class='btn' id='btnICS'>Add to Calendar</button>
    <a class='aLite' id='shareLink' href='#' target='_blank'>Open public LinkUp page</a>
    <span class='subtle' style='margin-left:auto'>ID: <code id='hid'>—</code></span>
  </section>
</main>

<script>
const nowISO = (ms=0)=> new Date(Date.now()+ms).toISOString();

function avatarDataURI(name){
  const initials = (name||'?').split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
  const hue = Math.abs([...name].reduce((a,c)=>a+c.charCodeAt(0),0)) % 360;
  const bg = `hsl(${hue},70%,22%)`; const fg = `hsl(${(hue+40)%360},75%,56%)`;
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect width='100%' height='100%' rx='128' ry='128' fill='${bg}'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='100' fill='${fg}' font-weight='700'>${initials}</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

const P = idx => `https://i.pravatar.cc/256?img=${idx}`;

const ACTION_LABEL = { schedule_call:'Schedule a Call', send_deck:'Send Portfolio', send_resume:'Send Resume', request_pricing:'Request Pricing', meet_coffee:'Meet for Coffee' };

const scenarios = {
  "A · High fit (Accepted)": {
    handshake_id: "H-A-001", role:"owner", status:"accepted",
    created_at: nowISO(-15*60*1000), action_due_at: nowISO(2*60*60*1000), expires_at: nowISO(6*24*60*60*1000),
    owner: { name:"Priya Shah", avatar: P(12), booking_url:"https://calendly.com/hello/15m", availability:"available" },
    viewer:{ name:"Diego Park", avatar: P(47), zip:"94107", action_choice:"schedule_call", one_liner:"Launching a wellness app—need UX audit + 15m intro" },
    compatibility:{ score:91, confidence:"High", bullets:["Strong overlap in product UX","Same city (4 mi)","Portfolio provided"] }
  },
  "B · Medium (Needs info)": {
    handshake_id: "H-B-002", role:"owner", status:"needs_info",
    created_at: nowISO(-55*60*1000), action_due_at: nowISO(30*60*1000), expires_at: nowISO(5*24*60*60*1000),
    owner: { name:"Mateo Alvarez", avatar: P(7), booking_url:"https://calendly.com/hello/30m", availability:"available" },
    viewer:{ name:"Riley Chen", avatar: P(21), zip:"", action_choice:"send_deck", one_liner:"Brand deck for fintech accelerator application" },
    compatibility:{ score:62, confidence:"Medium", bullets:["Relevant industry tags","Missing LinkedIn / Zip","Deck link provided"] }
  },
  "C · Low fit (Not a fit)": {
    handshake_id: "H-C-003", role:"owner", status:"not_a_fit",
    created_at: nowISO(-3*60*60*1000), action_due_at: nowISO(-60*60*1000), expires_at: nowISO(6*24*60*60*1000),
    owner: { name:"Ari Jones", avatar: P(2), booking_url:"https://calendly.com/hello/15m", availability:"available" },
    viewer:{ name:"Sam Brooks", avatar: P(32), zip:"73301", action_choice:"request_pricing", one_liner:"Looking for bulk photo retouching (1000 imgs/wk)" },
    compatibility:{ score:34, confidence:"High", bullets:["Outside listed services","Different region","No portfolio link"] },
    decline_message: "Thanks for reaching out. This isn’t a fit right now."
  },
  "D · Fresh new (Owner away)": {
    handshake_id: "H-D-004", role:"owner", status:"new",
    created_at: nowISO(-5*60*1000), action_due_at: nowISO(47*60*60*1000), expires_at: nowISO(7*24*60*60*1000),
    owner: { name:"Alex Winterton", avatar: P(5), booking_url:"https://calendly.com/hello/intro", availability:"away", away_until: nowISO(3*24*60*60*1000) },
    viewer:{ name:"Jordan Lee", avatar: P(18), zip:"11238", action_choice:"schedule_call", one_liner:"Travel app MVP—need fast UI polish + design tokens" },
    compatibility:{ score:78, confidence:"High", bullets:["Mobile UX focus match","6 miles apart","Clear project intent"] }
  },
  "E · Expired (Closed)": {
    handshake_id: "H-E-005", role:"owner", status:"closed",
    created_at: nowISO(-9*24*60*60*1000), action_due_at: nowISO(-7*24*60*60*1000), expires_at: nowISO(-2*24*60*60*1000),
    owner: { name:"Nina Okoro", avatar: P(28), booking_url:"https://calendly.com/hello/coffee", availability:"available" },
    viewer:{ name:"Ben Ortiz", avatar: P(49), zip:"30318", action_choice:"meet_coffee", one_liner:"In town next week—coffee to chat collab?" },
    compatibility:{ score:70, confidence:"High", bullets:["Local coffee spots nearby","Matching availability windows","Clear next step"] }
  }
};

let payload = JSON.parse(JSON.stringify(scenarios["D · Fresh new (Owner away)"]));
const ui = { pending:null };

const $ = s => document.querySelector(s);
const fmt2 = n => String(n).padStart(2,'0');

function setImage(el, url, name){
  const fallback = avatarDataURI(name||'?');
  el.onerror = null;
  el.src = url && url.length ? url : fallback;
  el.addEventListener('error', ()=>{ el.src = fallback; }, { once:true });
  el.alt = name;
}

function renderIdentity(){
  setImage(document.getElementById('ownerAvatar'), payload.owner.avatar, payload.owner.name);
  setImage(document.getElementById('viewerAvatar'), payload.viewer.avatar, payload.viewer.name);
  document.getElementById('ownerName').textContent = payload.owner.name || '—';
  document.getElementById('viewerName').textContent = payload.viewer.name || '—';
  const away = payload.owner.availability === 'away';
  document.getElementById('awayBadge').style.display = away ? 'inline-block' : 'none';
}

function renderIntent(){
  const lbl = ACTION_LABEL[payload.viewer.action_choice] || payload.viewer.action_choice || '—';
  document.getElementById('intentPill').textContent = lbl;
  document.getElementById('intentText').textContent = payload.viewer.one_liner || '—';
}

function renderSummary(){
  const isOwner = payload.role==='owner';
  document.getElementById('confidenceLine').textContent = isOwner ? `Confidence: ${payload.compatibility.confidence}` : 'Quick snapshot';
  const ul = document.getElementById('bullets'); ul.innerHTML='';
  (payload.compatibility.bullets||[]).forEach(b=>{ const li=document.createElement('li'); li.textContent=b; ul.appendChild(li); });
  if((payload.compatibility.bullets||[]).length===0){ const li=document.createElement('li'); li.textContent='—'; ul.appendChild(li); }
  document.getElementById('scoreBox').style.display = isOwner ? 'block' : 'none';
  if(isOwner){ document.getElementById('scoreText').textContent = `${payload.compatibility.score||0}/100`; document.getElementById('scoreBar').style.width = (payload.compatibility.score||0)+'%'; }
}

function setPhases(){
  const map = { new:0, needs_info:1, accepted:2, not_a_fit:2, scheduled:3, closed:3 };
  const idx = map[payload.status] ?? 0;
  ['#tlSubmitted','#tlViewed','#tlActed','#tlScheduled'].forEach((sel,i)=>{ $(sel).classList.toggle('active', i<=idx); });
  const pct = [0, 33, 66, 100][idx] || 0;
  document.getElementById('pbar').style.width = pct + '%';
  const exp = new Date(payload.expires_at);
  const now = new Date();
  const untilExp = Math.max(0, Math.round((exp-now)/1000));
  const expStr = `${Math.floor(untilExp/86400)}d ${fmt2(Math.floor((untilExp%86400)/3600))}h ${fmt2(Math.floor((untilExp%3600)/60))}m`;
  document.getElementById('expiryText').textContent = `Expires in ${expStr}`;
}

const COPY = {
  accept:{ title:'Confirm: Accept & Send Link', help:'Viewer will see “Congrats on the Handshake!” and your booking link opens. You can change status later.' },
  needs:{ title:'Confirm: Request 2 details', help:'We will ask the viewer for two quick items (LinkedIn, Zip). Score updates when provided.' },
  decline:{ title:'Confirm: Not a Fit', help:'Review the exact message below. The viewer will receive this wording.' }
};

function showConfirm(kind){
  ui.pending = kind;
  document.getElementById('confirmBox').style.display = 'block';
  document.getElementById('confirmTitle').textContent = COPY[kind].title;
  document.getElementById('confirmHelp').textContent = COPY[kind].help;
  document.getElementById('actions').style.display = 'none';
  document.getElementById('needsForm').style.display = 'none';
  document.getElementById('actionNote').textContent = '—';
  const de = document.getElementById('declineEdit');
  de.style.display = (kind==='decline') ? 'block' : 'none';
  if(kind==='decline'){
    const ta = document.getElementById('declineMsg');
    ta.value = payload.decline_message || "Thanks for reaching out. This isn’t a fit right now.";
    document.getElementById('declinePreview').textContent = '“' + ta.value + '”';
    ta.oninput = () => { document.getElementById('declinePreview').textContent = '“' + ta.value + '”'; };
  }
}

function hideConfirm(){
  ui.pending = null;
  document.getElementById('confirmBox').style.display = 'none';
  document.getElementById('actions').style.display = 'grid';
}

function awayNote(){
  const ownerAway = payload.owner.availability === 'away';
  if(!ownerAway) return '';
  const until = payload.owner.away_until ? new Date(payload.owner.away_until) : null;
  const untilStr = until ? `${until.toLocaleDateString()} ${until.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : 'soon';
  return `Owner is currently away${until? ' until '+untilStr : ''}. Replies may be delayed.`;
}

function renderActions(){
  const wrap = document.getElementById('actions'); wrap.innerHTML=''; document.getElementById('needsForm').style.display='none'; document.getElementById('confirmBox').style.display='none';
  const isOwner = payload.role==='owner'; const note = document.getElementById('actionNote');
  const ownerAway = payload.owner.availability === 'away';
  const btn = (t,c='')=>{ const b=document.createElement('button'); b.className='btn '+c; b.textContent=t; return b; };
  switch(payload.status){
    case 'new':
      if(isOwner){
        const a=btn('Accept & Send Link','primary'); a.disabled = ownerAway; a.onclick=()=>!ownerAway && showConfirm('accept');
        const n=btn('Needs Info'); n.onclick=()=>showConfirm('needs');
        const d=btn('Not a Fit'); d.onclick=()=>showConfirm('decline');
        wrap.append(a,n,d);
        note.textContent = ownerAway ? (awayNote() || 'Owner is away.') : 'Choose one action to keep this LinkUp fresh.';
      } else {
        const w=btn('Awaiting owner action'); w.disabled=true; wrap.append(w);
        const extra = awayNote(); note.textContent = extra || 'You will see the next step here once the owner acts.';
      }
      break;
    case 'needs_info':
      if(isOwner){ const x=document.createElement('div'); x.className='note'; x.textContent='Requesting two quick details from the viewer…'; wrap.append(x); note.textContent='You can accept once details arrive.'; }
      else { const add=btn('Add 2 details','primary'); add.onclick=()=>{document.getElementById('needsForm').style.display='grid'; wrap.style.display='none';}; wrap.append(add); note.textContent='Add LinkedIn + Zip to improve your snapshot.'; }
      break;
    case 'accepted':
      if(isOwner){ const open=btn('Open Booking','primary'); open.onclick=()=>window.open(payload.owner.booking_url,'_blank'); const rev=btn('Revert to Needs Info'); rev.onclick=()=>{payload.status='needs_info'; renderAll();}; wrap.append(open,rev); note.textContent='Send your booking link and finalize the handshake.'; }
      else { const book=btn('Book 15 min','primary'); book.onclick=()=>window.open(payload.owner.booking_url,'_blank'); wrap.append(book); note.textContent='Congrats on the Handshake! Pick a time.'; }
      break;
    case 'not_a_fit':
      if(isOwner){ const f=btn('Not a fit (this time)'); f.disabled=true; wrap.append(f); note.textContent = 'Message to Viewer: “' + (payload.decline_message||'') + '”'; }
      else { const msg=btn('Owner responded'); msg.disabled=true; wrap.append(msg); note.textContent = '“' + (payload.decline_message||'') + '”'; }
      break;
    case 'scheduled':
    case 'closed':
      const c=btn('Open Calendar','primary'); c.onclick=()=>alert('Open ICS link'); wrap.append(c); note.textContent='This LinkUp is closed.';
      break;
  }

  document.getElementById('btnBack').onclick = ()=>{ hideConfirm(); };
  document.getElementById('btnConfirm').onclick = ()=>{
    if(ui.pending==='accept') payload.status='accepted';
    if(ui.pending==='needs') payload.status='needs_info';
    if(ui.pending==='decline'){ payload.status='not_a_fit'; payload.decline_message = document.getElementById('declineMsg').value.trim() || "Thanks for reaching out. This isn’t a fit right now."; }
    hideConfirm(); renderAll();
  };

  document.getElementById('submitNeeds').onclick = () => {
    const li = document.getElementById('linkedin').value.trim();
    const zip = document.getElementById('zip').value.trim();
    payload.compatibility.bullets = [ ...(li?['LinkedIn provided']:[]), ...(zip?['Zip: '+zip]:[]), 'Snapshot updating…' ];
    payload.status='new'; renderSummary(); document.getElementById('needsForm').style.display='none'; wrap.style.display='grid'; renderActions();
  };
  document.getElementById('btnBackForm').onclick = () => { document.getElementById('needsForm').style.display='none'; wrap.style.display='grid'; };
}

function updateScenarioAvailLabel(){
  const away = payload.owner.availability === 'away';
  document.getElementById('scenarioAvail').textContent = away ? '· Owner Away' : '· Owner Available';
  // Show/Hide Away-until control
  document.getElementById('awayCtl').style.display = away ? 'flex' : 'none';
  if(away){
    // Prefill datetime-local (convert ISO to local)
    if(payload.owner.away_until){
      const d = new Date(payload.owner.away_until);
      const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
      document.getElementById('awayUntil').value = tz;
    }
  }
}

function attachAwayControls(){
  const input = document.getElementById('awayUntil');
  if(input){
    input.onchange = ()=>{
      const val = input.value; // local string
      if(!val){ payload.owner.away_until = null; return; }
      const dt = new Date(val);
      payload.owner.away_until = dt.toISOString();
      renderAll();
    };
  }
  document.querySelectorAll('.preset').forEach(el=>{
    el.onclick = ()=>{
      const days = parseInt(el.dataset.days||'1',10);
      const d = new Date();
      d.setDate(d.getDate()+days);
      payload.owner.away_until = d.toISOString();
      renderAll();
    };
  });
}

function renderAll(){ renderIdentity(); renderIntent(); renderSummary(); renderActions(); setPhases(); updateScenarioAvailLabel(); attachAwayControls(); document.getElementById('shareLink').href='#'+payload.handshake_id; }

const sel = document.getElementById('scenarioSel');
Object.keys(scenarios).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
sel.value = "D · Fresh new (Owner away)";
sel.onchange = () => { payload = JSON.parse(JSON.stringify(scenarios[sel.value])); syncAvailChips(); renderAll(); };

document.getElementById('asViewer').onclick = () => { payload.role='viewer'; document.getElementById('asOwner').classList.remove('active'); document.getElementById('asViewer').classList.add('active'); renderAll(); };
document.getElementById('asOwner').onclick = () => { payload.role='owner'; document.getElementById('asViewer').classList.remove('active'); document.getElementById('asOwner').classList.add('active'); renderAll(); };

function syncAvailChips(){
  const on = payload.owner.availability !== 'away';
  document.getElementById('availOn').classList.toggle('active', on);
  document.getElementById('availOff').classList.toggle('active', !on);
}
document.getElementById('availOn').onclick = () => { payload.owner.availability='available'; syncAvailChips(); renderAll(); };
document.getElementById('availOff').onclick = () => { payload.owner.availability='away'; if(!payload.owner.away_until){ const d=new Date(); d.setDate(d.getDate()+3); payload.owner.away_until=d.toISOString(); } syncAvailChips(); renderAll(); };

document.getElementById('btnVCard').onclick = ()=> alert('Download vCard (mock)');
document.getElementById('btnICS').onclick = ()=> alert('Download ICS (mock)');

syncAvailChips(); renderAll(); setInterval(setPhases, 15000);
</script>
</body>
</html>
